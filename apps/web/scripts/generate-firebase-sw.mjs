#!/usr/bin/env node
import { config } from 'dotenv';
import { writeFile } from 'fs/promises';
import { dirname, resolve } from 'path';
import { fileURLToPath } from 'url';

const __dirname = dirname(fileURLToPath(import.meta.url));

// Load .env files (Next.js priority order)
config({ path: resolve(__dirname, '../.env.local') });
config({ path: resolve(__dirname, '../.env') });

function requiredEnv(key) {
  const v = process.env[key];
  return typeof v === 'string' && v.length > 0 ? v : null;
}

const envMap = {
  apiKey: 'NEXT_PUBLIC_FIREBASE_API_KEY',
  authDomain: 'NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN',
  projectId: 'NEXT_PUBLIC_FIREBASE_PROJECT_ID',
  storageBucket: 'NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET',
  messagingSenderId: 'NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID',
  appId: 'NEXT_PUBLIC_FIREBASE_APP_ID',
  measurementId: 'NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID' // optional
};

const missing = [];
const firebaseConfig = {};
for (const [k, envKey] of Object.entries(envMap)) {
  const v = requiredEnv(envKey);
  if (!v && k !== 'measurementId') missing.push(envKey);
  if (v) firebaseConfig[k] = v;
}

if (missing.length) {
  console.error('[generate-firebase-sw] Missing env vars needed to generate firebase-messaging-sw.js:');
  for (const m of missing) console.error('  -', m);
  console.error('\nSet these in your build environment (CI/Docker) or in a local .env before running the build.');
  process.exit(1);
}

// Build the firebase config object literal safely (escape backticks)
function jsonStr(v) {
  return String(v).replace(/`/g, '\\`');
}

const measurementLine = firebaseConfig.measurementId ? `,\n  measurementId: "${jsonStr(firebaseConfig.measurementId)}"` : '';

const sw = `/* Auto-generated by apps/web/scripts/generate-firebase-sw.mjs */\n/* global importScripts, firebase */\n\nimportScripts("https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js");\nimportScripts("https://www.gstatic.com/firebasejs/10.12.0/firebase-messaging-compat.js");\n\nfirebase.initializeApp({\n  apiKey: "${jsonStr(firebaseConfig.apiKey)}",\n  authDomain: "${jsonStr(firebaseConfig.authDomain)}",\n  projectId: "${jsonStr(firebaseConfig.projectId)}",\n  storageBucket: "${jsonStr(firebaseConfig.storageBucket)}",\n  messagingSenderId: "${jsonStr(firebaseConfig.messagingSenderId)}",\n  appId: "${jsonStr(firebaseConfig.appId)}"${measurementLine}\n});\n\nconst messaging = firebase.messaging();\n\nmessaging.onBackgroundMessage((payload) => {\n  console.log(\n    "[firebase-messaging-sw.js] Received background message ",\n    payload\n  );\n\n  const notificationTitle = payload.notification?.title || "New notification";\n  const notificationOptions = {\n    body: payload.notification?.body || "",\n    icon: "/icon-192x192.png",\n    badge: "/icon-72x72.png",\n    data: payload.data || {},\n    requireInteraction: true,\n    // Browser will use default notification sound\n    silent: false,\n    actions: payload.data?.actions || [\n      { action: 'open', title: 'Open App' }\n    ],\n  };\n\n  // Show the notification with default system sound\n  self.registration.showNotification(notificationTitle, notificationOptions);\n});\n\n// When user clicks the notification\nself.addEventListener("notificationclick", function (event) {\n  event.notification.close();\n  const urlToOpen = event.notification.data?.url || "/";\n\n  event.waitUntil(\n    clients.matchAll({ type: "window", includeUncontrolled: true }).then((clientList) => {\n      // If the user clicked an action button, you can handle it here via event.action\n      if (event.action) {\n        // Example: if action === 'open' we open the URL (fallback default)\n        if (event.action === 'open') {\n          for (const client of clientList) {\n            if ("focus" in client) {\n              client.focus();\n              client.navigate(urlToOpen);\n              return;\n            }\n          }\n          if (clients.openWindow) {\n            return clients.openWindow(urlToOpen);\n          }\n        }\n      }\n\n      for (const client of clientList) {\n        if ("focus" in client) {\n          client.focus();\n          // Use navigate if available\n          if (typeof client.navigate === 'function') {\n            client.navigate(urlToOpen);\n          } else {\n            // Fallback: post a message asking the client to route\n            client.postMessage({ type: 'route', url: urlToOpen });\n          }\n          return;\n        }\n      }\n      if (clients.openWindow) {\n        return clients.openWindow(urlToOpen);\n      }\n    })\n  );\n});\n`;

const outPath = `${__dirname}/../public/firebase-messaging-sw.js`;

writeFile(outPath, sw, { encoding: 'utf8' })
  .then(() => {
    console.log('[generate-firebase-sw] Wrote', outPath);
  })
  .catch((err) => {
    console.error('[generate-firebase-sw] Failed to write', outPath, err);
    process.exit(2);
  });
