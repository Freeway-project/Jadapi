name: Deploy to VPS

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types:
      - completed
    branches:
      - main
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '10.4.1'

jobs:
  deploy:
    name: Deploy to Production VPS
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')

    steps:
      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            echo "üöÄ Starting deployment..."

            # Navigate to project directory
            cd /home/ubuntu/Jadapi || exit 1

            # Pull latest changes from main
            echo "üì• Pulling latest changes from main branch..."
            git pull origin main

            # Stop existing containers
            echo "üõë Stopping existing containers..."
            docker compose down

            # Build new images
            echo "üî® Building Docker images..."
            docker compose build --no-cache

            # Start containers
            echo "‚ñ∂Ô∏è  Starting containers..."
            docker compose up -d

            # Wait for services to be healthy
            echo "‚è≥ Waiting for services to be healthy..."
            sleep 10

            # Check container status
            echo "üìä Container status:"
            docker compose ps

            # Check server health
            echo "üè• Checking server health..."
            for i in {1..30}; do
              if curl -s http://localhost:5000/health > /dev/null 2>&1; then
                echo "‚úÖ Server is healthy!"
                break
              fi
              echo "Attempt $i/30: Server not ready yet..."
              sleep 2
            done

            # Clean up old images
            echo "üßπ Cleaning up old Docker images..."
            docker image prune -f

            echo "‚úÖ Deployment completed successfully!"

      - name: Notify Deployment Status
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "‚úÖ Deployment to VPS succeeded"
          else
            echo "‚ùå Deployment to VPS failed"
            exit 1
          fi
